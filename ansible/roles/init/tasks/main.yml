---
# INIT
- name: get auto-generated admin password from pod - timeout {{ admin_password_script_timeout_mins }} mins
  shell: |
    podName=$(kubectl get pod --namespace {{ nexus_namespace }} -l app.kubernetes.io/name=sonatype-nexus -o jsonpath="{.items[0].metadata.name}")

    # kubectl cp --namespace {{ nexus_namespace }} {{role_path}}/files/get_admin_password.sh "$podName":/tmp/get_admin_password.sh
    cat {{role_path}}/files/get_admin_password.sh | kubectl exec -i -n {{ nexus_namespace }} "$podName" "--" sh -c "cat > /tmp/get_admin_password.sh"

    kubectl exec --namespace {{ nexus_namespace }} "$podName" -- sh -c "chmod +x /tmp/get_admin_password.sh; timeout {{ admin_password_script_timeout_mins }}m /tmp/get_admin_password.sh"

  # ignore_errors: yes
  register: admin_password_result

- name: debug get auto-generated admin password
  debug:
    var: admin_password_result
  # when: enable_debug_output == "true"

- name: set autogenerated_admin_password
  set_fact:
    autogenerated_admin_password: "{{ admin_password_result.stdout }}"

- name: wait for Nexus API to respond
  uri:
    url: "{{ api_url }}/v1/status/writable"
    status_code: 200
    validate_certs: false
  register: result
  until:
    - result.status == 200
  # 30 x 10secs = 5mins
  retries: 30
  delay: 10
  # reset module defaults for this simple check
  module_defaults:
    uri: {}


# SECURITY
- name: test admin access
  uri:
    url: "{{ api_url }}/v1/status/"
    method: GET
    user: "admin"
    password: "{{ admin_password }}"
    status_code: 200,401
  ignore_errors: true
  register: admin_access_response

- name: change admin password
  uri:
    url: "{{ api_url }}/v1/security/users/admin/change-password"
    method: PUT
    user: "admin"
    password: "{{ autogenerated_admin_password }}"
    headers:
      Content-Type: text/plain
    body: "{{ admin_password }}"
    status_code: 200,204
  when: admin_access_response.status != 200
  register: admin_password_response

- name: debug change admin password
  debug:
    var: admin_password_response
  when: enable_debug_output == "true"

- name: set admin password changed marker file
  shell: |
    podName=$(kubectl get pod --namespace {{ nexus_namespace }} -l app.kubernetes.io/name=sonatype-nexus -o jsonpath="{.items[0].metadata.name}")

    kubectl exec --namespace {{ nexus_namespace }} "$podName" -- sh -c "touch /nexus-data/admin-password-changed"
  when: admin_password_response.status is defined and admin_password_response.status == 204

- name: set active realms
  uri:
    url: "{{ api_url }}/v1/security/realms/active"
    method: PUT
    body: "{{ active_realms }}"
    status_code: 200,204

- name: delete default repos
  uri:
    url: "{{ api_url }}/v1/repositories/{{ item }}"
    method: DELETE
    status_code: 204,404
  loop: "{{ repos_to_remove }}"
  register: del_repo_response
  changed_when: del_repo_response.status == 204


# REPOS
- name: list repos
  uri:
    url: "{{ api_url }}/v1/repositories"
    method: GET
    status_code: 200
  register: repositories

- name: debug repos
  debug:
    var: repositories
  when: enable_debug_output == "true"

- name: extract repo names
  set_fact:
    repo_names: "{{ repositories.json | map( attribute='name' ) | list }}"

- name: debug repo names
  debug:
    var: repo_names
  when: enable_debug_output == "true"
